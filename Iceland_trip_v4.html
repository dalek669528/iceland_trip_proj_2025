<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冰島追夢之旅 2025 - 行程儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #E5E7EB; /* gray-200 */
        }
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1533423929014-a3939f435889?q=80&w=2670&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            filter: brightness(0.5);
        }
        .main-container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem; /* Adjusted for mobile */
        }
        @media (min-width: 640px) {
            .main-container {
                padding: 2rem;
            }
        }
        .glass-card {
            background: rgba(17, 24, 39, 0.8); /* gray-900 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .day-tab {
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .day-tab.active {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .day-tab:not(.active):hover {
             background-color: #374151; /* gray-700 */
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.125rem; /* left-4.5 */
            top: 1.5rem; /* top-6 */
            bottom: -0.5rem; /* bottom-[-2] */
            width: 2px;
            background-color: #4B5563; /* gray-600 */
            transform: translateX(-50%);
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 1.125rem; /* left-4.5 */
            top: 1.5rem; /* top-6 */
            width: 1rem;
            height: 1rem;
            border-radius: 9999px; /* rounded-full */
            background-color: #4B5563; /* gray-600 */
            border: 2px solid #1F2937; /* gray-800 */
            transform: translateX(-50%);
        }
        /* Custom scrollbar for day tabs */
        .tabs-container::-webkit-scrollbar {
            height: 6px;
        }
        .tabs-container::-webkit-scrollbar-track {
            background: #1F2937; /* gray-800 */
            border-radius: 10px;
        }
        .tabs-container::-webkit-scrollbar-thumb {
            background: #4B5563; /* gray-600 */
            border-radius: 10px;
        }
        .tabs-container::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900">

    <div class="background-container"></div>

    <div class="main-container">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white tracking-tight">冰島追夢之旅 2025</h1>
            <p class="text-base sm:text-lg text-gray-300 mt-2">行程總覽儀表板</p>
        </header>

        <!-- Day Navigation Tabs -->
        <nav class="mb-8">
            <div id="day-tabs" class="tabs-container flex items-center space-x-2 overflow-x-auto pb-2">
                <!-- Day tabs will be dynamically inserted here -->
            </div>
        </nav>

        <!-- Content Display Area -->
        <main id="content-display" class="glass-card p-4 sm:p-6 md:p-8">
            <!-- Initial state will be rendered here by script -->
            <div id="loading-state" class="flex justify-center items-center h-full min-h-[40vh]">
                <p class="text-lg sm:text-xl text-gray-400 text-center">正在載入行程資料...</p>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-400 text-sm">
            <p>資訊來源：冰島行程住宿規劃.xlsx</p>
        </footer>
    </div>

    <script>
        // --- DATA LOADING & FALLBACK ---

        const fallbackItineraryCSVData = `
第一天：10 月 11 日（六） - 抵達冰島，溫泉與市區補給,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,google link
08:00,抵達 凱夫拉維克國際機場 (KEF),,,抵達後，領取行李並準備前往租車公司。,
08:30-09:30,前往 Blue Car Rental 取車,15 分鐘,30 分鐘,租車：已租用兩台 Rav4，確保行李與乘坐空間充足。辦理手續時，請備妥所有駕駛的駕照正本與國際駕照。,
09:30-10:00,開車前往 藍湖溫泉,20 分鐘,,在車上稍作休息，為接下來的溫泉體驗做準備。,
10:00-11:00,提早抵達 藍湖溫泉,,1 小時,已提前預約 11:00 入場。 可先在咖啡廳休息或逛逛紀念品店。,
11:00-13:00,藍湖溫泉體驗,,2 小時,盡情放鬆身心，享受獨特的溫泉體驗。,
13:00-14:00,開車前往 Costco 與 IKEA,40 分鐘,,準備進行接下來幾天的食物與日用品補給。,
14:00-16:00,Costco 與 IKEA 採買,,2 小時,兩個地點各停留一小時。由於團隊人數較多，在 Costco 採買會更划算。,
16:00-17:00,開車前往 雷克雅維克市區,35 分鐘,,開車前往 Airbnb 辦理入住。,
17:00-18:00,Airbnb 入住,,1 小時,安頓行李，短暫休息。,
18:00-19:00,雷克雅維克市區自由活動,,依個人喜好,探索市中心，可步行前往哈爾格林姆教堂、太陽航海者等景點。,
19:00,晚餐時間,,依個人喜好,在市中心享用晚餐，體驗冰島在地美食。,
,,,,,,
第二天：10 月 12 日（日） - 悠閒探索雷克雅維克市區,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
09:00-10:00,在 Airbnb 享用早餐,,1 小時,在 Airbnb 自炊早餐，可以節省開銷，也更具彈性。,
10:00-11:00,前往哈爾格林姆教堂,步行,1 小時,可搭電梯至頂樓鳥瞰市區，非常適合團體拍照留念。,
11:00-12:30,逛街與漫步,步行,1.5 小時,從教堂前往主街 Laugavegur，是尋找紀念品與特色商店的好去處。 建議可在此區尋找 66°NORTH 旗艦店採購。,
12:30-14:00,午餐時間,步行,1.5 小時,可選擇在市區餐廳用餐，或是在港口邊享用當地特色熱狗。,
14:00-15:30,前往哈帕音樂廳,步行,1.5 小時,欣賞建築之美，並從內部觀賞舊港口風景。,
15:30-17:00,舊港口漫步,步行,1.5 小時,可以在舊港口散步，欣賞漁船與海景。,
17:00-18:00,返回住宿處,步行,1 小時,返回 Airbnb 休息，準備晚餐。,
18:00,晚餐時間,步行,依個人喜好,可在市區享受晚餐，或在 Airbnb 準備晚餐，享受團體時光。,
,,,,,,
第三天：10 月 13 日（一） - 黃金圈與南岸精華,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
07:30-08:00,前往 Sandholt 買早餐,步行,30 分鐘,提早出發。在離開市區前，可先到知名的 Sandholt 烘焙坊購買麵包與咖啡當作早餐與路上點心。,
08:00,從 雷克雅維克市區 出發,,,為今天的長途駕駛和多個景點預留充足時間。,
08:45-10:00,辛格維利爾國家公園,45 分鐘,1.5 小時,建議步行路線：停車場（P1）→ 板塊裂縫峽谷步道 → 觀景台 → 返回停車場。此路線最省時，約 1.5 小時。,
11:00-11:45,蓋錫爾間歇泉,1 小時,45 分鐘,等待間歇泉噴發。,
12:00-13:00,古佛斯瀑布,15 分鐘,1 小時,瀑布氣勢磅礡，需特別注意地面濕滑。可在此處稍作休息。,
13:00-14:00,午餐時間,,1 小時,建議在古佛斯瀑布的餐廳用餐，節省時間。,
14:00-15:30,前往 塞里雅蘭瀑布,1.5 小時,,在車上休息，為下午的瀑布之旅養精蓄銳。,
15:30-16:00,塞里雅蘭瀑布,,30 分鐘,瀑布水量大，請小心地濕。十月水量較大，不建議繞行至瀑布後方。 若時間不足，可考慮跳過。,
16:30-17:00,斯科加爾瀑布,30 分鐘,30 分鐘,冰島最經典的瀑布之一。可爬上階梯從高處俯瞰全景。,
17:30-18:00,前往 黑沙灘 (Reynisfjara),30 分鐘,30 分鐘,注意日落時間。 十月中旬日落時間約為 17:50。建議在天黑前抵達，欣賞完畢後直接前往維克住宿。 若當天時間不足，可考慮隔天早上再前往。,
18:15,抵達 維克,15 分鐘,,入住維克住宿 - The Barn。,
18:30,晚餐時間,,,結束一天的行程，在維克享受晚餐和休息，可準備隔天及後天午餐。,
,,,,,,
第四天：10 月 14 日（二） - 冰川健行與冰河湖巡禮,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
08:00,從 維克 出發,,,務必提早出發，為中途的景點預留充足時間。,
08:20-09:00,迪霍拉里 (Dyrhólaey),20 分鐘,40 分鐘,早上光線較好，適合觀賞海蝕洞與燈塔。,
10:00-11:00,羽毛峽谷 (Fjaðrárgljúfur),1 小時,1 小時,彈性選擇：這座峽谷景色壯麗，但路程較遠。若當天時間充裕，可考慮前往；若時間不足，可直接前往冰川健行集合地點。,
12:00,抵達 斯卡夫塔費爾,1 小時,,直接前往 Glacier Guides 報到處，並找時間享用午餐。,
12:20-13:00,報到、領取裝備、簡報,,40 分鐘,必須在 12:40 前抵達！,
13:00-17:00,「Glacier Wonders」冰川健行,,4 小時,盡情享受冰川上的奇景。,
17:45-18:15,抵達 鑽石沙灘,45 分鐘,30 分鐘,在鑽石沙灘上尋找閃閃發光的浮冰。,
18:30,抵達 哈利鄉村旅館 (Hali Country Hotel),15 分鐘,,入住住宿地點，享用晚餐及準備隔天午餐。,
,,,,,,
第五天：10 月 15 日（三） - 冰河船與東南岸的寧靜小鎮,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
08:30,在 哈利鄉村旅館 用早餐,,,享受悠閒的早餐時光，為今天的行程做準備。,
09:00-16:00,「Glacier Magic」冰河健行與冰河船,15 分鐘,7 小時,活動地點位於哈利，您可以輕鬆前往。此為全日行程，包含午餐時間。,
16:00,前往 霍夫 (Höfn),1 小時,,結束活動後，開車前往霍夫，車程不長。,
17:00,抵達 霍夫 (Höfn)，霍夫自由活動,,依個人喜好,您可以探索這個美麗的小鎮，並在傍晚時分尋找當地的特色餐廳，或是超市準備晚餐食材。,
18:30,晚餐時間,,,霍夫以新鮮龍蝦聞名，非常推薦您品嚐。,
,,,,,,
第六天：10 月 16 日（四） - 東部峽灣的挑戰與美景,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
08:00,從 霍夫 (Höfn) 出發,,,今天是長途車程，務必提早出發，並隨時注意路況。,
11:30-12:30,在 埃伊爾斯塔濟 用午餐,3.5 小時,1 小時,建議在此地用餐，並稍作休息，為下午的行程做準備。 路途中可考慮在都皮沃古爾（Djúpivogur）稍作休息。,
12:30-13:00,前往 塞濟斯菲厄澤 (Seyðisfjörður),30 分鐘,,此路段在十月可能會有積雪。 務必在出發前，查詢 冰島公路狀況網站，確認路況安全後再前往。,
13:00-14:00,塞濟斯菲厄澤小鎮探索,,1 小時,欣賞這個美麗的東部小鎮，著名的彩虹階梯就在這裡。,
14:00-15:00,返回 埃伊爾斯塔濟,30 分鐘,30 分鐘,返回埃伊爾斯塔濟，準備前往米湖地區，可先在超市採買。,
15:00-17:30,前往 雷恰利茲 (Reykjahlíð) 補給,2.5 小時,,備註：這裡有小型超市和加油站，可以在此處採買缺少的食材。,
17:30-18:00,前往 Guesthouse Helluland,30 分鐘,,從雷恰利茲前往住宿地點。,
18:00,抵達 Guesthouse Helluland,,,入住住宿地點。 Guesthouse Helluland需要自行準備晚餐，抵達後可以好好休息，也可以前往米湖泡溫泉，並在夜晚尋找極光。 備註：請準備隔天午餐。,
,,,,,,
第七天：10 月 17 日（五） - 米湖地區與北部溫泉,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
08:00,從 Guesthouse Helluland 出發,,,務必在天亮後出發。,
08:30-9:30,胡薩維克（Húsavík）,30 分鐘,1 小時,前往這個知名的賞鯨小鎮。您可以在小鎮漫步，購買一些點心咖啡為今天的行程準備。,
11:00-12:00,前往 黛提瀑布（Dettifoss）,1.5 小時,1 小時,建議走862公路前往西岸觀景點，欣賞歐洲水量最大的瀑布。,
12:30-13:30,前往 克拉夫拉火山與維提火山湖,1 小時,,**備註：**可以在車上或是米湖周邊簡單用餐。,
13:30-14:30,克拉夫拉火山與維提火山湖探索,,1 小時,近距離欣賞這座火山與美麗的火山口湖。,
15:30-17:00,眾神瀑布 (Goðafoss),1 小時,1.5 小時,從不同角度觀賞這座優美的瀑布。若當天時間不足，可考慮隔天早上再前往。,
17:00-17:30,前往 阿克雷里,30 分鐘,,開車前往冰島北部最大的城市。,
17:30,抵達 阿克雷里,,,入住住宿地點，並在市區進行自由活動。,
18:00,阿克雷里市區探索及晚餐,步行,依個人喜好,您可以逛逛市區，參觀阿克雷里教堂或到港口散步及享用晚餐。,
,,,,,,
第八天：10 月 18 日（六） - 北部景點與西部峽谷,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
09:00,從 阿克雷里 出發,,,在市區用完早餐後出發。,
09:30-11:00,阿克雷里市區探索 或 眾神瀑布 (Goðafoss),30 分鐘,1.5 小時,您可以逛逛市區，參觀阿克雷里教堂或到港口散步。\ 若前一天沒能逛逛眾神瀑布，可利用這天早上從不同角度觀賞這座優美的瀑布。,
11:00-11:30,返回 阿克雷里,30 分鐘,,返回阿克雷里，準備用午餐。,
11:30-13:00,午餐時間,,1.5 小時,在阿克雷里市區用餐，有更多美食選擇。,
13:00,從 阿克雷里 出發,,,根據當下情況，決定前往巨人峽谷或犀牛岩。,
13:00-15:30,方案一：巨人峽谷 (Kolugljúfur),2.5 小時,,開往巨人峽谷的車程，請注意路況與天氣。,
13:00-15:30,方案二：犀牛岩 (Hvítserkur),2.5 小時,,開往犀牛岩的車程，路段可能較為顛簸，駕駛時需小心。,
15:30-17:00,景點停留時間,,1.5 小時,在景點盡情拍照，享受風景。,
17:00-18:30,前往 布扎達呂爾 (Búðardalur),1.5 小時,,從景點開往布扎達呂爾，可在天黑前抵達。,
18:30,抵達 布扎達呂爾 (Búðardalur),,,安頓行李，並在小鎮進行補給。,
19:30,晚餐時間,,,可以在小鎮準備晚餐，享受寧靜的夜晚。,
,,,,,,
第九天：10 月 19 日（日） - 斯奈山半島全日探索 (逆時針),,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
08:30,從 布扎達呂爾 出發,,,在小鎮用完早餐後出發，準備以逆時針方向遊覽斯奈山半島。,
09:30-10:00,"Good view, Snæfellsnesvegur",1 小時,30 分鐘,在開往半島的路上，可在此處停留，欣賞風景。,
10:30-11:30,前往 斯蒂基斯霍爾米 (Stykkishólmur),30 分鐘,1 小時,可以逛逛這個小鎮，及前往小鎮的超市，採買當天午餐與晚餐的食材。,
12:00-12:30,教會山 (Kirkjufell),30 分鐘,30 分鐘,欣賞斯奈山半島最上鏡的山脈，可以在車上或路程中享用午餐。,
13:00-13:30,Ingjaldshólskirkja 教堂,30 分鐘,30 分鐘,這就是傳聞中的「視力檢查小屋」，一座以紅頂聞名的教堂。,
14:00-15:30,黑沙灘 (Djúpalónssandur)\ 怪物海岸 (Londrangar)(遊客中心) \ 阿爾納斯塔皮 (Arnarstapi)\ 赫爾納 (Hellnar),30 分鐘,1.5 小時,可以在這幾個半島西南岸的景點逛逛，欣賞海岸線的玄武岩奇景。,
16:00-16:30,布迪爾黑教堂 (Búðir)\ 海豹沙灘 (Ytri Tunga),30 分鐘,30 分鐘,斯奈山半島上知名的地標，可以從不同角度拍攝這座獨特的教堂。\ 或是前往海豹沙灘，觀察海豹的棲息，要注意地面可能濕滑。,
16:30-18:00,前往 斯奈山半島住宿,1.5 小時,,開車前往當晚的住宿地點，提早抵達休息。,
18:00,抵達 斯奈山半島住宿,,,辦理入住，在住宿處準備晚餐。,
19:00,晚餐時間,,,在住宿處享用晚餐，享受寧靜的夜晚，尋找極光。,
,,,,,,
第十天：10 月 20 日（一） - 返回雷克雅維克,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
09:00,從 斯奈山半島 出發,,,開始返回雷克雅維克的路程，車程約 2.5 小時。,
10:00-12:00,博爾加內斯 (Borgarnes),1 小時,2 小時,在小鎮休息、用午餐，並欣賞海岸線風光。,
13:30,抵達 雷克雅維克,1.5 小時,,入住奧丁斯維酒店 (Hotel Odinsve)。,
14:30,雷克雅維克市區自由活動,,依個人喜好,享受在市區的最後時光，購買紀念品或享受美食。,
19:00,晚餐時間,,依個人喜好,可在市中心享用晚餐，好好享受在冰島的最後一晚。,
第十一天：10 月 21 日（二） - 悠閒與返程,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
09:00,在 雷克雅維克 自由活動,,依個人喜好,在市區享用悠閒早餐。,
09:30,前往 Sky Lagoon,30 分鐘,,前往溫泉，享受返國前的最後一次放鬆。,
10:00,Sky Lagoon 溫泉體驗,,2-3 小時,在溫泉中盡情放鬆身心，從另一種角度欣賞冰島風景。,
13:00,午餐時間,,1 小時,可以在溫泉旁享用簡單午餐或回市區用餐。,
14:00,前往 凱夫拉維克國際機場 (KEF),40 分鐘,,提早前往機場，準備還車。,
14:40,Blue Car Rental 還車,,依車況,還車並辦理登機手續。,
第十二天：10 月 22 日（三） - 抵達台北,,,,,
時間,行程,建議交通時間,建議停留時間,備註與建議,
全天,轉機與返程,,,抵達桃園國際機場，結束美好旅程。,
`;
        const fallbackAccommodationCSVData = `
,地區,平台,房型,早餐,廚房,停車,Link,地址,Map Link
10/11-10/13,雷克雅維克 Reykjavik,AirBnb,整棟,x,v,路邊,AirBnB Link,"Bergþórugata 35 2, 雷克雅維克, Reykjavíkurborg 101, 冰島",https://maps.app.goo.gl/zGtwcjfEUzn76h9S8
10/12-10/13,雷克雅維克 Reykjavik,AirBnb,整棟,x,v,路邊,AirBnB Link,"Bergþórugata 35 2, 雷克雅維克, Reykjavíkurborg 101, 冰島",https://maps.app.goo.gl/zGtwcjfEUzn76h9S8
10/13-10/14,Vik,Booking,雙人房*1 + 6床房,x,共用廚房,v,The Barn,"Norðurfoss, 871 維克, 冰島",https://maps.app.goo.gl/GiVajEPkb1DoUQFG7
10/14-10/15,Hali,Booking,雙人房*2 + 獨棟雙人房*2,v,其中一間有,v,哈利鄉村酒店,"Hali 2, 781 Jökulsárlón, 冰島",https://maps.app.goo.gl/P26FPQSv5o6DLKVFA
10/15-10/16,赫本 Hofn,Booking,整棟,x,v,v,"The Greyhouse ""Big Apartment""","Seljavellir, 781 霍芬, 冰島",https://maps.app.goo.gl/6eaKZhXkfskmX3hj9
10/16-10/17,胡薩維克,AirBnb,整棟,x,v,v,AirBnB Link,"Helluland 641, 641冰島",https://maps.app.goo.gl/Jz4Un38SdRKWDjkq8
10/17-10/18,阿克雷里 Akureyri,Booking,四人房+雙人房*2,x,v,v,E18 Apartments,"18 Eiðsvallagata, 600 阿克雷里, 冰島",https://maps.app.goo.gl/H7Vo2usTx7NjdGvM7
10/18-10/19,布扎達呂爾 Búðardalur,Booking,四人房+雙人房*2,x,v,v,城堡民宿,"Brekkuhvammur 1, 370 布札達呂爾, 冰島",https://maps.app.goo.gl/aa8HjXru6pbMJayA8
10/19-10/20,阿爾納斯塔皮 Arnarstapi,Booking,整棟,x,v,v,Grund,"Grund, 311 Rauðamelur, 冰島",https://maps.app.goo.gl/XXK1bGmvcAvS782w8
10/20-10/21,雷克雅維克 Reykjavik,Booking,雙人房*4,x,x,,奧丁斯維酒店,"Thorsgata 1, 101 雷克雅維克, 冰島",https://maps.app.goo.gl/tdSRB1K34M7VELtw5
`;
        
        async function loadTripData() {
            try {
                // Try to fetch data from external CSV files
                const [itineraryResponse, accommodationResponse] = await Promise.all([
                    fetch('itinerary.csv'),
                    fetch('accommodation.csv')
                ]);

                if (!itineraryResponse.ok || !accommodationResponse.ok) {
                    throw new Error('CSV files not found or failed to load. Status: ' + itineraryResponse.status + ', ' + accommodationResponse.status);
                }
                
                const itineraryData = await itineraryResponse.text();
                const accommodationData = await accommodationResponse.text();

                console.log("Successfully loaded data from itinerary.csv and accommodation.csv.");
                return { itineraryData, accommodationData };

            } catch (error) {
                console.warn("Could not load data from CSV files. Using hardcoded fallback data.", error.message);
                return { 
                    itineraryData: fallbackItineraryCSVData, 
                    accommodationData: fallbackAccommodationCSVData 
                };
            }
        }

        // --- PARSING LOGIC ---
        
        /**
         * A robust function to parse a single line of a CSV file.
         * It correctly handles quoted fields containing commas.
         * @param {string} line - The line from the CSV file.
         * @returns {string[]} An array of fields.
         */
        function parseCsvLine(line) {
            const parts = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    parts.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            parts.push(currentField); // Add the last field
            return parts.map(field => field.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
        }


        function parseItinerary(csvString) {
            const lines = csvString.trim().split(/\r?\n/);
            const tripData = [];
            let currentDayData = null;

            const dayHeaderRegex = /^第(.+?)天：(.+?)\s*[-－–—]\s*(.+?)(,)*$/;

            lines.forEach(line => {
                const dayMatch = line.match(dayHeaderRegex);
                if (dayMatch) {
                    if (currentDayData) {
                        tripData.push(currentDayData);
                    }
                    currentDayData = {
                        day: dayMatch[1].trim(),
                        date: dayMatch[2].trim().replace('（', ' (').replace('）', ')'),
                        title: dayMatch[3].trim(),
                        events: []
                    };
                } else if (currentDayData && line.trim() && !line.startsWith('時間,行程')) {
                    const parts = parseCsvLine(line); // Use the new robust parser
                    
                    if (parts.length >= 2 && parts[0]) {
                        currentDayData.events.push({
                            time: parts[0] || 'N/A',
                            activity: parts[1] || 'N/A',
                            travelTime: parts[2] || '',
                            stayTime: parts[3] || '',
                            notes: parts[4] || '',
                            googleLink: parts[5] || ''
                        });
                    }
                }
            });

            if (currentDayData) {
                tripData.push(currentDayData);
            }
            return tripData;
        }

        function parseAccommodation(csvString) {
            const lines = csvString.trim().split(/\r?\n/);
            const accommodationMap = {};
            // Start from 1 to skip header
            for(let i=1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                const parts = parseCsvLine(line); // Use the new robust parser

                if (parts.length < 1) continue;

                const [dateRange, region, platform, roomType, breakfast, kitchen, parking, link, address, mapLink] = parts;

                if (!dateRange || !dateRange.trim()) {
                    continue;
                }

                const accommodation = {
                    region, platform, roomType, breakfast, kitchen, parking, 
                    link, address, mapLink
                };

                const [startDateStr, endDateStr] = dateRange.split('-');
                const [startMonth, startDay] = startDateStr.split('/').map(Number);
                
                const [endMonth, endDay] = endDateStr ? endDateStr.split('/').map(Number) : [startMonth, startDay + 1];

                let currentDate = new Date(2025, startMonth - 1, startDay);
                let endDate = new Date(2025, endMonth - 1, endDay);
                
                while(currentDate < endDate) {
                    const key = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                    accommodationMap[key] = accommodation;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            return accommodationMap;
        }


        // --- RENDERING LOGIC ---

        function renderDayDetails(dayData, accommodationData) {
            const contentDisplay = document.getElementById('content-display');
            
            // Itinerary HTML
            const itineraryHtml = `
                <div class="mb-8 lg:mb-0">
                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="list-checks" class="w-6 h-6 mr-3 text-blue-400"></i>
                        行程安排
                    </h3>
                    <div class="relative pl-8">
                        ${dayData.events.map(event => `
                            <div class="timeline-item relative pl-8 pb-8">
                                <div class="timeline-dot"></div>
                                <p class="text-blue-300 font-semibold">${event.time}</p>
                                <h4 class="text-lg font-semibold text-gray-100 mt-1">
                                    ${event.activity.replace(/\\/g, ' &bull; ')}
                                    ${event.googleLink ? `<a href="${event.googleLink}" target="_blank" rel="noopener noreferrer" class="inline-block ml-2 text-blue-400 hover:text-blue-300 align-middle"><i data-lucide="map-pin" class="w-4 h-4"></i></a>` : ''}
                                </h4>
                                ${event.notes ? `<p class="text-gray-400 mt-1 text-sm">${event.notes}</p>` : ''}
                                <div class="flex items-center space-x-4 mt-2 text-xs text-gray-400">
                                    ${event.travelTime ? `<div class="flex items-center"><i data-lucide="car" class="w-3 h-3 mr-1"></i><span>${event.travelTime}</span></div>` : `<div class="flex items-center"><i data-lucide="car" class="w-3 h-3 mr-1"></i><span>-</span></div>`}
                                    ${event.stayTime ? `<div class="flex items-center"><i data-lucide="clock" class="w-3 h-3 mr-1"></i><span>${event.stayTime}</span></div>` : `<div class="flex items-center"><i data-lucide="clock" class="w-3 h-3 mr-1"></i><span>-</span></div>`}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            
            // Accommodation HTML
            const accommodationHtml = accommodationData ? `
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="home" class="w-6 h-6 mr-3 text-green-400"></i>
                        今晚住宿
                    </h3>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-lg border border-gray-700">
                        <div class="flex justify-between items-start">
                             <h4 class="text-lg sm:text-xl font-bold text-white">${accommodationData.region}</h4>
                             <span class="text-sm font-medium ${accommodationData.platform === 'AirBnb' ? 'bg-pink-600' : 'bg-blue-600'} text-white px-2 py-1 rounded-full">${accommodationData.platform}</span>
                        </div>
                        <p class="text-gray-300 mt-1 mb-4 font-semibold text-sm sm:text-base">${accommodationData.link}</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mt-4">
                            <div class="flex items-start"><i data-lucide="bed-double" class="w-4 h-4 mr-2 mt-1 text-gray-400 flex-shrink-0"></i><div><span class="font-semibold text-gray-300">房型:</span> ${accommodationData.roomType || 'N/A'}</div></div>
                            <div class="flex items-center"><i data-lucide="parking-circle" class="w-4 h-4 mr-2 text-gray-400"></i><span class="font-semibold text-gray-300">停車:</span> ${accommodationData.parking === 'v' ? '提供' : '無'}</div>
                            <div class="flex items-center"><i data-lucide="coffee" class="w-4 h-4 mr-2 text-gray-400"></i><span class="font-semibold text-gray-300">早餐:</span> ${accommodationData.breakfast === 'v' ? '提供' : '無'}</div>
                            <div class="flex items-center"><i data-lucide="soup" class="w-4 h-4 mr-2 text-gray-400"></i><span class="font-semibold text-gray-300">廚房:</span> ${(accommodationData.kitchen && (accommodationData.kitchen.includes('v') || accommodationData.kitchen.includes('有'))) ? '提供' : '無'}</div>
                        </div>

                        <a href="${accommodationData.mapLink}" target="_blank" rel="noopener noreferrer" class="mt-6 flex items-center text-blue-400 hover:text-blue-300 transition-colors duration-200 text-sm">
                           <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                           <span class="underline">${accommodationData.address}</span>
                        </a>
                    </div>
                </div>
            ` : `
                 <div>
                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="moon-star" class="w-6 h-6 mr-3 text-purple-400"></i>
                        今晚住宿
                    </h3>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 text-center">
                        <p class="text-gray-400">今天沒有預定的住宿資訊（可能是搭乘飛機或行程結束）。</p>
                    </div>
                </div>
            `;

            contentDisplay.innerHTML = `
                <h2 class="text-2xl sm:text-3xl font-bold text-white mb-1">第 ${dayData.day} 天: ${dayData.title}</h2>
                <p class="text-base sm:text-lg text-gray-400 mb-6 sm:mb-8">${dayData.date}</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    ${itineraryHtml}
                    ${accommodationHtml}
                </div>
            `;
            lucide.createIcons(); // Re-render icons
        }


        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', async () => {
            const dayTabsContainer = document.getElementById('day-tabs');
            const contentDisplay = document.getElementById('content-display');

            try {
                const { itineraryData, accommodationData } = await loadTripData();
                
                const tripData = parseItinerary(itineraryData);
                const accommodationMap = parseAccommodation(accommodationData);
                
                if (tripData.length === 0) {
                    throw new Error("解析行程資料後為空陣列。請檢查 CSV 檔案格式。");
                }
                
                // Clear loading state and prepare for tabs
                dayTabsContainer.innerHTML = '';
                contentDisplay.innerHTML = `
                    <div id="initial-message" class="flex justify-center items-center h-full min-h-[40vh]">
                        <p class="text-lg sm:text-xl text-gray-400 text-center">請選擇一天來查看詳細行程</p>
                    </div>`;

                tripData.forEach((day, index) => {
                    const tab = document.createElement('button');
                    tab.className = 'day-tab px-4 py-2 rounded-lg text-sm font-semibold bg-gray-800 text-gray-300 border border-gray-700';
                    tab.innerHTML = `第 ${day.day} 天 <span class="hidden sm:inline-block ml-2 text-gray-400">${day.date.split(' ')[0]}</span>`;
                    tab.onclick = () => {
                        document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const dateParts = day.date.match(/(\d+) 月 (\d+) 日/);
                        let accommodationDataForDay = null;
                        if(dateParts) {
                            const key = `${dateParts[1]}/${dateParts[2]}`;
                            accommodationDataForDay = accommodationMap[key];
                        }
                        renderDayDetails(day, accommodationDataForDay);
                    };
                    dayTabsContainer.appendChild(tab);
                });
                
                // Auto-select the first day on load
                if (dayTabsContainer.firstElementChild) {
                    dayTabsContainer.firstElementChild.click();
                }

            } catch (error) {
                 console.error("初始化行程時發生嚴重錯誤:", error);
                 contentDisplay.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full min-h-[40vh] text-center">
                        <i data-lucide="alert-triangle" class="w-12 h-12 text-red-400 mb-4"></i>
                        <h3 class="text-xl font-bold text-red-300">載入行程資料時發生錯誤</h3>
                        <p class="text-gray-400 mt-2">請檢查 CSV 檔案格式是否正確，或查看開發者 Console 的詳細訊息。</p>
                    </div>`;
            }

            lucide.createIcons();
        });

    </script>
</body>
</html>

